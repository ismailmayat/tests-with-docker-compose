version: "3.8"

networks:
  azure-function-development:
    driver: bridge

services:
  seed:
    image: mcr.microsoft.com/dotnet/core/sdk:3.1
    volumes:
      - ./Sample.App.Database:/code
    links:
      - db
    depends_on:
      - db
    command:
      ["./wait-for-it.sh", "db:1433", "--", "dotnet", "run", "DropAndDatabase"]
    working_dir: /code
    environment:
      Sample_App_ConnectionString: "Server=db; Database=$DB_NAME; User id=$DB_USER; Password=$DB_PASSWORD"
    networks:
      - azure-function-development

  db:
    image: mcr.microsoft.com/mssql/server:2019-latest
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "$DB_PASSWORD"
    networks:
      - azure-function-development

  fun:
    build:
      context: .
      args:
        LOCAL: "true"
    environment:
      AzureWebJobsStorage: "UseDevelopmentStorage=true"
      FUNCTIONS_WORKER_RUNTIME: "node"
      sqlServer: "db"
      sqlPort: 1433
      sqlDatabase: "$DB_NAME"
      sqlUsername: "$DB_USER"
      sqlPassword: "$DB_PASSWORD"
    ports:
      - "7071:80"
    depends_on:
      - seed
      - db
    links:
      - db
    networks:
      - azure-function-development
